<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="高性能JavaScript," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="一礼拜前就把这本书用边看边做笔记的方式的看完了，只能说是一本好书，相对于我另外看的一本国人写的书真的好太多了。

高性能JS加载和执行无阻塞下载JS
带有defer属性的&amp;lt;script&amp;gt;元素对应的JS文件将在页面解析到&amp;lt;script&amp;gt;元素时开始下载，但是不会执行，直到DOM加载完成（onload事件被触发前）被调用。
123456789101112131415&amp;lt;sc">
<meta property="og:type" content="article">
<meta property="og:title" content="《高性能JS》笔记">
<meta property="og:url" content="http://chulinyin.com/2016/09/13/高性能JS-杂记/index.html">
<meta property="og:site_name" content="褚林银的秘密基地">
<meta property="og:description" content="一礼拜前就把这本书用边看边做笔记的方式的看完了，只能说是一本好书，相对于我另外看的一本国人写的书真的好太多了。

高性能JS加载和执行无阻塞下载JS
带有defer属性的&amp;lt;script&amp;gt;元素对应的JS文件将在页面解析到&amp;lt;script&amp;gt;元素时开始下载，但是不会执行，直到DOM加载完成（onload事件被触发前）被调用。
123456789101112131415&amp;lt;sc">
<meta property="og:updated_time" content="2016-09-13T15:22:54.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="《高性能JS》笔记">
<meta name="twitter:description" content="一礼拜前就把这本书用边看边做笔记的方式的看完了，只能说是一本好书，相对于我另外看的一本国人写的书真的好太多了。

高性能JS加载和执行无阻塞下载JS
带有defer属性的&amp;lt;script&amp;gt;元素对应的JS文件将在页面解析到&amp;lt;script&amp;gt;元素时开始下载，但是不会执行，直到DOM加载完成（onload事件被触发前）被调用。
123456789101112131415&amp;lt;sc">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://chulinyin.com/2016/09/13/高性能JS-杂记/"/>


  <title> 《高性能JS》笔记 | 褚林银的秘密基地 </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">褚林银的秘密基地</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Write down my thinking</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                《高性能JS》笔记
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-13T23:11:29+08:00" content="2016-09-13">
              2016-09-13
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/13/高性能JS-杂记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/13/高性能JS-杂记/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/09/13/高性能JS-杂记/" class="leancloud_visitors" data-flag-title="《高性能JS》笔记">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>一礼拜前就把这本书用边看边做笔记的方式的看完了，只能说是一本好书，相对于我另外看的一本国人写的书真的好太多了。</p>
</blockquote>
<h2 id="高性能JS"><a href="#高性能JS" class="headerlink" title="高性能JS"></a>高性能JS</h2><h3 id="加载和执行"><a href="#加载和执行" class="headerlink" title="加载和执行"></a>加载和执行</h3><h4 id="无阻塞下载JS"><a href="#无阻塞下载JS" class="headerlink" title="无阻塞下载JS"></a>无阻塞下载JS</h4><ul>
<li><p>带有defer属性的<code>&lt;script&gt;</code>元素对应的JS文件将在页面解析到<code>&lt;script&gt;</code>元素时开始下载，但是不会执行，直到DOM加载完成（onload事件被触发前）被调用。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">defer</span>&gt;</span><span class="javascript"></span></div><div class="line">	alert(<span class="string">'defer'</span>);</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">	alert(<span class="string">'script'</span>);</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"></span></div><div class="line">  <span class="built_in">window</span>.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    alert(<span class="string">'load'</span>);</div><div class="line">  &#125;</div><div class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"></div><div class="line">// script  defer   load</div></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>动态脚本加载，由于其在跨浏览器兼容性和易用的优势，成为最通用的无阻塞加载解决方案。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadScript</span>(<span class="params">url,callback</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</div><div class="line">  script.type = <span class="string">'text/javascript'</span>;</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(script.readyState)&#123; <span class="comment">// IE</span></div><div class="line">    script.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="keyword">if</span>(script.readyState == <span class="string">'loaded'</span> || script.readyState == <span class="string">'complete'</span>)&#123;</div><div class="line">        script.onreadystatechange == <span class="literal">null</span>;</div><div class="line">        callback();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    script.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      callback();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  script.src = url;</div><div class="line">  <span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>].appendChild(script);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>使用XHR对象下载JS代码并注入页面中（不能跨域）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHTTPRequest();</div><div class="line">xhr.open(<span class="string">'get'</span>,<span class="string">'file.js'</span>,<span class="literal">true</span>);</div><div class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">	<span class="keyword">if</span>(xhr.readyState == <span class="number">4</span>)&#123;</div><div class="line">      <span class="keyword">if</span>(xhr.status&gt;=<span class="number">200</span> &amp;&amp; xhr.status&lt;<span class="number">300</span> || xhr.status == <span class="number">304</span>)&#123;</div><div class="line">        <span class="keyword">var</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</div><div class="line">        script.type = <span class="string">'text/javascript'</span>;</div><div class="line">        script.text = xhr.responseText;</div><div class="line">        <span class="built_in">document</span>.body.appendChild(script);</div><div class="line">      &#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">xhr.send(<span class="literal">null</span>);</div></pre></td></tr></table></figure>
<p>​</p>
<a id="more"></a> 
<h3 id="数据访问"><a href="#数据访问" class="headerlink" title="数据访问"></a>数据访问</h3></li>
</ul>
<h4 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h4><p>每个函数有一个隐藏的内部属性[[scope]]，其中包含了一个函数被创建的作用域中对象的集合，这个集合被称为函数的作用域链，它决定哪些数据能被函数访问。</p>
<p>执行函数时，会创建一个称为”运行期上下文“的内部对象。一个运行期上下文定义了一个函数执行时的环境。函数每次执行时对应的运行期上下文都是独一无二的，所以多次调用同一个函数就会导致创建多个运行期上下文。</p>
<p><strong>如果某个跨作用域的值在函数中被引用一次以上，那么就把它存储到局部变量里（如<code>document</code>）。</strong>因为局部变量在作用域链的起始位置，而全局变量总处在作用域链的最末端。</p>
<h4 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h4><p>闭包函数与非闭包函数想必，需要更多的内存开销。你要经常访问大量跨作用域的变量，每次访问都会导致性能损失。不过可以将常用的跨作用域变量存储在局部变量中，然后直接访问局部变量，来减轻闭包对执行速度的影响。</p>
<h4 id="原型"><a href="#原型" class="headerlink" title="原型"></a>原型</h4><p>属性或方法在原型链中的位置越深，访问速度越慢。所以<strong>在函数中如果要多次读取同一个对象属性，最佳做法是将属性值保存到局部变量中（但是不适用于对象的方法）。</strong>局部变量能用来替代属性以避免多次查找带来的性能开销。<strong>不要在同一个函数里多次查找一个对象成员，除非它的值改变了。</strong></p>
<h3 id="DOM编程"><a href="#DOM编程" class="headerlink" title="DOM编程"></a>DOM编程</h3><p>DOM是个与语言无关的API，它在浏览器中的接口确实用JS实现的，而浏览中通常会把DOM和JS独立实现。这就意味着JS访问DOM次数越多，性能消耗越多。（两座岛屿的过桥费）</p>
<h4 id="DOM访问与修改"><a href="#DOM访问与修改" class="headerlink" title="DOM访问与修改"></a>DOM访问与修改</h4><ul>
<li>bad: 修改元素，会导致浏览器重新计算页面的几何变化。</li>
<li>worest: 在循环中访问或修改元素，尤其是对HTML元素集合循环操作。</li>
<li>HTML集合是包含了DOM节点引用的类数组对象，当DOM更新时，它也会自动更新。遍历数组比遍历集合快，读取一个普通数组的length比读取集合的length快很多。</li>
</ul>
<p>所以，访问DOM的次数越多，代码的运行速度越慢。一般的经验法则是：</p>
<ol>
<li><p><strong>减少访问DOM的次数，把运算尽量留在ECMAScript这一端处理。</strong></p>
</li>
<li><p><strong>使用DOM方法更新页面内容时使用<code>ele.cloneNode()</code>代替<code>document.createElement()</code>。</strong></p>
</li>
<li><p><strong>把集合的长度缓存到一个局部变量中，如果集合很大，可将元素先拷贝到数组中<code>arr = [].prototype.slice(HTMLCollection)</code>,如果要多次访问当集合元素中的某一元素，可将该元素存为局部变量。</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fast</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> coll = <span class="built_in">document</span>.getElementByTagName(<span class="string">'div'</span>);</div><div class="line">  len = coll.length;</div><div class="line">  name = <span class="string">''</span>;</div><div class="line">  el = <span class="literal">null</span>;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> count = <span class="number">0</span>; count &lt; len; count++)&#123;</div><div class="line">    el = coll[count]; <span class="comment">//缓存当前元素</span></div><div class="line">    name = el.nodeName;</div><div class="line">    name = el.nodeType;</div><div class="line">    name = el.tagName;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> name;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><strong>使用选择器API<code>ele.querySelectorAll() / ele.querySelector()</code></strong></p>
</li>
</ol>
<h4 id="重绘与重排"><a href="#重绘与重排" class="headerlink" title="重绘与重排"></a>重绘与重排</h4><h5 id="最小化重绘与重排"><a href="#最小化重绘与重排" class="headerlink" title="最小化重绘与重排"></a>最小化重绘与重排</h5><h5 id="缓存布局信息"><a href="#缓存布局信息" class="headerlink" title="缓存布局信息"></a>缓存布局信息</h5><h5 id="让元素脱离动画刘"><a href="#让元素脱离动画刘" class="headerlink" title="让元素脱离动画刘"></a>让元素脱离动画刘</h5><ol>
<li>绝对定位动画元素，让其脱离文档流。</li>
<li>让元素动起来。当它扩大时，会临时覆盖部分页面。但这只是页面一个小区域的重绘过程，不会产生重排并重绘页面的大部分内容。</li>
<li>当动画结束时恢复定位，从而只会下移一次文档的其他元素。</li>
</ol>
<h4 id="事件委托"><a href="#事件委托" class="headerlink" title="事件委托"></a>事件委托</h4><p>事件逐层冒泡并能被父级元素捕获。使用事件代理，只需给外层元素绑定一个处理器，就可以处理在其子元素上触发的所有事件。</p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><ol>
<li>最小化DOM访问次数，尽可能在JS端处理。</li>
<li>如果需要多次访问某个DOM节点，请使用局部变量存储它的引用。</li>
<li>小心处理HTML集合，因为它实时联系着底层文档。把集合的长度缓存到一个变量中，并在迭代中使用它。如果需要经常操作集合，建议把它拷贝到一个数组中。</li>
<li>如果可能的话，使用速度更快的API，比如<code>querySelectorAll()</code>、<code>querySelector()</code>和 <code>firstElementChild</code>。</li>
<li>要留意重绘和重排；批量修改样式（cssText、className），“离线”操作DOM树（documentFragment），缓存布局信息（offsetXxx、scrollXxx、clientXxx、getComputedStyle() ），并减少访问布局信息的次数。</li>
<li>动画中使用绝对定位，使用拖放代理。</li>
<li>使用事件委托来减少事件处理器的数量。</li>
</ol>
<h3 id="算法和流程控制"><a href="#算法和流程控制" class="headerlink" title="算法和流程控制"></a>算法和流程控制</h3><p>代码数量少一定运行速度快，代码数量多却也不意味着运速度一定慢。<strong>影响性能的最直接因素是代码的组织结构，以及具体问题的解决方法。</strong> </p>
<h4 id="循环性能"><a href="#循环性能" class="headerlink" title="循环性能"></a>循环性能</h4><p>一共四种循环，for、while、do-while、for-in，for-in每次迭代操作会同时搜索实例或原型属性，所以最慢。除非明确需要迭代一个属性数量未知的对象，否则避免使用for-in循环。如果需要变量一个数量有限的已知属性列表，使用其他循环类型会更快。</p>
<p>其他循环类型的性能都差不多，类型的选择更应基于需求而不是性能。</p>
<h5 id="减少迭代的工作量"><a href="#减少迭代的工作量" class="headerlink" title="减少迭代的工作量"></a>减少迭代的工作量</h5><p>限制循环中耗时操作的数量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 原始版本</span></div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;items.length; i++)&#123;</div><div class="line">  process(items[i]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>每次运行循环都会产生：</p>
<ol>
<li>一次控制条件中的属性查找 ( items.length )</li>
<li>一次控制条件中的数值大小比较 ( i &lt; items.length )</li>
<li>一次控制条件结果是否为true的比较 ( i&lt;items.length == true )</li>
<li>一次自增操作 ( i++ )</li>
<li>一次数组查找 ( items[i] )</li>
<li>一次函数调用 ( process(items[i]) )</li>
</ol>
<p>首先可以<strong>最小化属性查找</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 增强版1 缓存items.length</span></div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>, len=items.length; i&lt;len; i++)&#123;</div><div class="line">  process(items[i]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其次，如果数组项的顺序与所要执行的任务无关，可以<strong>减少属性查找并反转</strong>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 增强版2 没有i，控制条件与0比较</span></div><div class="line"><span class="keyword">for</span>(<span class="keyword">var</span> i=items.length; i--;)&#123;</div><div class="line">  process(items[i]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>每次循环只会产生：（减少了两次操作）</p>
<ol>
<li>一次控制条件中的比较 ( i == true )</li>
<li>一次减法操作 ( i– )</li>
<li>一次数组查找 ( items[i] )</li>
<li>一次函数调用 ( process(items[i]) )</li>
</ol>
<blockquote>
<p>当循环复杂度为O(n)时，减少迭代的工作量是最有效的方法。当复杂度大于O(n)，建议着重减少迭代次数。</p>
</blockquote>
<h5 id="减少迭代次数"><a href="#减少迭代次数" class="headerlink" title="减少迭代次数"></a>减少迭代次数</h5><p>最广为人知的一种限制循环迭代次数的模式被称为“达夫设备（Duff’s Device）”。</p>
<blockquote>
<p>高程还是C++prime中看到过…… </p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> i = items.length % <span class="number">8</span>;</div><div class="line"><span class="keyword">while</span>(i)&#123;</div><div class="line">  process(items[i--]);</div><div class="line">&#125;</div><div class="line"></div><div class="line">i =  <span class="built_in">Math</span>.floor(items.length / <span class="number">8</span>);</div><div class="line"><span class="keyword">while</span>(i)&#123;</div><div class="line">  process(items[i--]);</div><div class="line">  process(items[i--]);</div><div class="line">  process(items[i--]);</div><div class="line">  process(items[i--]);</div><div class="line">  process(items[i--]);</div><div class="line">  process(items[i--]);</div><div class="line">  process(items[i--]);</div><div class="line">  process(items[i--]);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="基于函数的迭代"><a href="#基于函数的迭代" class="headerlink" title="基于函数的迭代"></a>基于函数的迭代</h5><p>原生方法`arr.forEach(function(value, index, arr){})比基于循环的迭代慢一些。如果运行速度要求严格，则使用基于循环的迭代。</p>
<h4 id="条件语句性能"><a href="#条件语句性能" class="headerlink" title="条件语句性能"></a>条件语句性能</h4><p>通常来说，<code>if-else</code>适用于<strong>判断两个离散值</strong>或<strong>几个不同的值域</strong>。switch适用于<strong>判断多余两个离散值</strong>。</p>
<h5 id="优化if-else"><a href="#优化if-else" class="headerlink" title="优化if-else"></a>优化if-else</h5><p>目标：最小化到达正确分支前所需判断的条件数量。</p>
<ul>
<li>把最可能出现的条件放在首位</li>
<li>把if-else组织成一系列嵌套的if-else语句。使用二分法把值域分成一系列的区间，然后逐步缩小范围。</li>
</ul>
<h5 id="查找表"><a href="#查找表" class="headerlink" title="查找表"></a>查找表</h5><p>可以用数组和普通对象构造查找表，通过查找表访问数据比用if-else或switch快很多，可读性也更好，特别是在条件语句数量很大的时候。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span>(value)&#123;</div><div class="line">  <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">    <span class="keyword">return</span> result0;</div><div class="line">  <span class="keyword">case</span> <span class="number">1</span>:</div><div class="line">    <span class="keyword">return</span> result1;</div><div class="line">  ...</div><div class="line">  default:</div><div class="line">  	<span class="keyword">return</span> result0;</div><div class="line">&#125;</div><div class="line">=&gt;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getResult</span>(<span class="params">value</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> results = [result0, result1, result2......];</div><div class="line">  <span class="keyword">return</span> results[value]; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="递归性能"><a href="#递归性能" class="headerlink" title="递归性能"></a>递归性能</h4><p>存在问题是终止条件不明确或缺少终止条件会导致函数长时间运行。其次，递归还可能遇到浏览器的“调用栈大小限制”。</p>
<p>JS引擎支持的递归数量（固定）与JS调用栈大小直接相关。只有IE例外，它的调用栈与系统空闲内存有关。</p>
<h5 id="递归模式"><a href="#递归模式" class="headerlink" title="递归模式"></a>递归模式</h5><ol>
<li><p>直接递归模式，调用函数自身</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">recurse</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  recurse();</div><div class="line">&#125;</div><div class="line">recurse();</div></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>隐伏模式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">first</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  second();</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">second</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  first();</div><div class="line">&#125;</div><div class="line">first();</div></pre></td></tr></table></figure>
</li>
</ol>
<p>如果发生错误：</p>
<ol>
<li>验证终止条件</li>
<li>改用迭代、记忆函数（Memoization）,或者两者结合使用。</li>
</ol>
<h5 id="迭代"><a href="#迭代" class="headerlink" title="迭代"></a>迭代</h5><p>任何能用递归实现的算法也可以用迭代来实现。不过性能可能更好，因为运行一个循环比反复调用一个函数的开销少得多。</p>
<p>如合并排序算法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeSort</span>(<span class="params">items</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(items.length == <span class="number">1</span>)&#123;</div><div class="line">    <span class="keyword">return</span> items;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">var</span> middle = <span class="built_in">Math</span>.floor(items.length / <span class="number">2</span>);</div><div class="line">  <span class="keyword">var</span> left = items.slice(<span class="number">0</span>,middle);</div><div class="line">  <span class="keyword">var</span> right = items.slice(middle);</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> merge(mergeSort(left),mergeSort(right));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">merge</span>(<span class="params">left,right</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> result = [];</div><div class="line">  </div><div class="line">  <span class="keyword">while</span>(left.length&gt;<span class="number">0</span> &amp;&amp; right.length&gt;<span class="number">0</span>)&#123;</div><div class="line">    <span class="keyword">if</span>(left[<span class="number">0</span>]&lt;right[<span class="number">0</span>])&#123;</div><div class="line">      result.push(left.shift());</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">      result.push(right.shift());</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> result.concat(left).concat(right);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>尽管使用迭代版本的合并排序算法比递归实现得要慢一些，但它不会像递归版本那样受调用栈限制的影响。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 使用迭代 =&gt;</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeSort</span>(<span class="params">items</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(items.length == <span class="number">1</span>)&#123;</div><div class="line">    <span class="keyword">return</span> items;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">var</span> work = [];</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>m len=items.length; i&lt;len; i++)&#123;</div><div class="line">    work.push(items[i]);</div><div class="line">  &#125;</div><div class="line">  work.push([]); <span class="comment">//如果数组长度为奇数</span></div><div class="line">  </div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> lim=len; lim&gt;<span class="number">1</span>; lim=(lim+<span class="number">1</span>)/<span class="number">2</span>)&#123;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> j=<span class="number">0</span>,k=<span class="number">0</span>; k&lt;lim; j++, k+=<span class="number">2</span>)&#123;</div><div class="line">      work[j] = merge(work[k],work[k+<span class="number">1</span>]);</div><div class="line">    &#125;</div><div class="line">    work[j] = []; <span class="comment">//如果数组长度为奇数</span></div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> work[<span class="number">0</span>];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Memoization"><a href="#Memoization" class="headerlink" title="Memoization"></a>Memoization</h5><p>是一种避免重复工作的方法，它缓存前一个计算结果供后续计算使用，避免了重复工作。 </p>
<p>以下代码中有3次阶乘计算，使factorial()函数一共被调用了18次，因为每次都要重新计算整个函数。而使用记忆函数可以保存并重用它们的计算结果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fact6 = factorial(<span class="number">6</span>);</div><div class="line"><span class="keyword">var</span> fact5 = factorial(<span class="number">5</span>);</div><div class="line"><span class="keyword">var</span> fact4 = factorial(<span class="number">4</span>);</div></pre></td></tr></table></figure>
<p>使用Memoization技术重写factorial()函数,此时3次阶乘只调用了memfactorial()函数8次</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">memfactorial</span>(<span class="params">n</span>)</span>&#123;</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(!memfactorial.cache)&#123;</div><div class="line">    memfactorial.cache = &#123;</div><div class="line">      <span class="string">"0"</span>: <span class="number">1</span>,</div><div class="line">      <span class="string">"1"</span>: <span class="number">1</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(!memfactorial.cache.hasOwnProperty(n))&#123;</div><div class="line">    memfactorial.cache[n] = n*memfactorial(n<span class="number">-1</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">return</span> memfactorial.cache[n];</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> fact6 = memfactorial(<span class="number">6</span>);</div><div class="line"><span class="keyword">var</span> fact5 = memfactorial(<span class="number">5</span>);</div><div class="line"><span class="keyword">var</span> fact4 = memfactorial(<span class="number">4</span>);</div></pre></td></tr></table></figure>
<p>为了使记忆函数更加通用，可以对它进行封装</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">memoize</span>(<span class="params">fundamental, cache</span>)</span>&#123;</div><div class="line">  cache = cache || &#123;&#125;;</div><div class="line">  </div><div class="line">  <span class="keyword">var</span> shell = <span class="function"><span class="keyword">function</span>(<span class="params">arg</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(!cache.hasOwnProperty(arg))&#123;</div><div class="line">      cache[arg] = fundamental(arg);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> cache[arg];</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> shell;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 缓存阶乘函数</span></div><div class="line"><span class="keyword">var</span> memfactorial = memoize(factorial, &#123;<span class="string">"0"</span>: <span class="number">1</span>, <span class="string">"1"</span>: <span class="number">1</span>&#125;);</div><div class="line"><span class="comment">// 调用新函数</span></div><div class="line"><span class="keyword">var</span> fact6 = memfactorial(<span class="number">6</span>);</div><div class="line"><span class="keyword">var</span> fact5 = memfactorial(<span class="number">5</span>);</div><div class="line"><span class="keyword">var</span> fact4 = memfactorial(<span class="number">4</span>);</div></pre></td></tr></table></figure>
<p>当memoization函数存显著性能问题时，最好有针对性地手工实现它，而不是直接用通用Memoization方案。</p>
<h4 id="总结：-1"><a href="#总结：-1" class="headerlink" title="总结："></a>总结：</h4><ol>
<li>for、while和do-while循环性能相似</li>
<li>避免使用for-in循环，除非需要遍历一个属性数量未知的对象</li>
<li>改善循环性能的最佳方式是减少每次迭代的运算量和减少循环迭代次数</li>
<li>一般switch总比if-else快，但并不总是最佳方案</li>
<li>在判断条件较多时，使用查找表比if-else和switch更快</li>
<li>浏览器的调用栈大小限制了递归算法在JS中的应用；栈溢出错误会导致其他代码中断运行</li>
<li>如果遇到栈溢出错误，可将方法改为迭代算法，或使用Memoization来避免重复计算</li>
</ol>
<h3 id="字符串和正则表达式"><a href="#字符串和正则表达式" class="headerlink" title="字符串和正则表达式"></a>字符串和正则表达式</h3><h4 id="字符串连接"><a href="#字符串连接" class="headerlink" title="字符串连接"></a>字符串连接</h4><p>一些常见方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">str = <span class="string">'a'</span> + <span class="string">'b'</span> + <span class="string">'c'</span>;</div><div class="line"></div><div class="line">str = <span class="string">'a'</span>;</div><div class="line">str += <span class="string">'b'</span>;</div><div class="line">str += <span class="string">'c'</span>;</div><div class="line"><span class="comment">// 也可以 str = str + 'b' + 'c'</span></div><div class="line"><span class="comment">// 不建议使用 str += 'b' + 'c'</span></div><div class="line"></div><div class="line">str = [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>].join(<span class="string">''</span>);</div><div class="line"></div><div class="line">str = <span class="string">'a'</span>;</div><div class="line">str = str.concat(<span class="string">'b'</span>, <span class="string">'c'</span>);</div><div class="line"><span class="comment">// str = String.prototype.concat.apply(str,['b','c']);</span></div></pre></td></tr></table></figure>
<h4 id="正则表达式优化："><a href="#正则表达式优化：" class="headerlink" title="正则表达式优化："></a>正则表达式优化：</h4><p>草率地编写正则表达式可能是造成性能瓶颈的主要原因，但也有很多提高正则表达式运行效率的办法。</p>
<h5 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h5><ol>
<li><p>编译</p>
<p>创建正则对象后，浏览器会验证其模式，转化为一个原生代码程序（用于执行匹配工作）</p>
</li>
<li><p>设置起始位置</p>
<p>使用正则时，它首先确定目标字符串的其实搜索位置。它是字符串的起始字符，或者由正则表达式的lastIndex属性（只用于exec和test方法，并且正则必须有/g标识）指定。</p>
</li>
<li><p>匹配每个正则表达式字元</p>
<p>正则知道开始位置后，逐个检查文本和正则表达式模式。当一个特定的字元匹配失败时，正则表达式会试着<strong>回溯到之前尝试匹配的位置上</strong>，然后尝试其他可能的路径。</p>
</li>
<li><p>匹配成功或失败</p>
<ul>
<li>如果在字符串当前位置发现了一个完全匹配，那么正则表达式宣布匹配成功。</li>
<li>如果正则表达式所有的可能路径都没有匹配到，正则表达式引擎会会退到第二步，然后从下一个字符重新尝试。只有当字符串的每个字符（以及最后一个字符串后面的位置）都经历这个过程后，还没有成功匹配，那么正则表达式就宣布彻底匹配失败。</li>
</ul>
</li>
</ol>
<h5 id="理解回溯"><a href="#理解回溯" class="headerlink" title="理解回溯"></a>理解回溯</h5><p>回溯是匹配过程的基础组成部分。然而它会产生昂贵的计算消耗，一不小心就会失控。</p>
<p>如果当前选项匹配成功，正则表达式继续扫描匹配模式，如果其他部分也匹配成功，那么匹配结束。但是如果当前选项找不到匹配值，或后面的部分匹配失败，那么正则表达式会回溯到最后一个决策点，然后在剩余的选项中选一个。这个过程会一直进行，知道找到匹配项，或者正则表达式中量词和分支选项的所有排列组合都尝试失败，那么它将放弃匹配，转而移动到字符串中的下一个字符。</p>
<ul>
<li><strong>分支回溯</strong></li>
<li><strong>重复回溯</strong></li>
</ul>
<h5 id="回溯失控"><a href="#回溯失控" class="headerlink" title="回溯失控"></a>回溯失控</h5><p>当正则表达式导致浏览器假死数秒、数分钟……问题可能是因为回溯失控                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <strong>嵌套量词与回溯失控：</strong> ？</p>
<h5 id="解决方案：具体化、使用向前查看和反向引用模拟原子组"><a href="#解决方案：具体化、使用向前查看和反向引用模拟原子组" class="headerlink" title="解决方案：具体化、使用向前查看和反向引用模拟原子组"></a>解决方案：具体化、使用向前查看和反向引用模拟原子组</h5><p>原子组的目的是使正则引擎回溯结束得更快一点。因此可以有效阻止海量回溯。原子组的语法是<code>?&gt;正则表达式</code>。位于<code>?&gt;</code>之间的所有正则表达式都会被认为是一个单一的正则符号。一旦匹配失败，引擎将会回溯到原子组前面的正则表达式部分。</p>
<p>不过JS不支持原子组，也没有提供其他方法消除不必要的回溯。不过，可以利用向前查看过程中一项鲜为人知的行为来模拟：<strong>向前查看也是原子组</strong>。它们的区别是，向前查看在匹配过程中不消耗任何字符串作为全局匹配的一部分；而只是检查自己包含的正则符号在当前字符串位置是否匹配。但是，可以通过把向前查看的模式封装在捕获组中并给它添加一个反向引用的方法来避免这一问题。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">(?=(pattern to make atomic))\<span class="number">1</span></div></pre></td></tr></table></figure>
<p>在任何打算使用原子团的模式中使用这个结构都是可重用的。但是记住：如果你的正则表达式包含了一个以上的捕获组，那么需要使用适当的反向引用次数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/(A+A+)+B/</div><div class="line"> <span class="regexp">/AA+B/</span></div><div class="line"> /((?=(A+A+))\<span class="number">2</span>)+B/</div></pre></td></tr></table></figure>
<h4 id="更多提高正则表达式效率的方法"><a href="#更多提高正则表达式效率的方法" class="headerlink" title="更多提高正则表达式效率的方法"></a>更多提高正则表达式效率的方法</h4><ol>
<li><p>关注如何让匹配更快失败</p>
</li>
<li><p>正则表达式以简单、必需的字元开始</p>
<p>通常是一个锚（^或$）、特定字符串（x或\u263A）、字符类（[a-z]或类似/d的速记标记）和单词边界（\b）。尽量避免以分组或选择字元开头，避免类似<code>/one|two/</code>的顶层分支，因为它强迫正则识别多种起始字元。</p>
</li>
<li><p>使用量词模式，使它们后面的字元互斥</p>
<p>尽量具体化匹配模式</p>
</li>
<li><p>减少分支数量，缩小分支范围</p>
<p>通常可以通过使用字符集和选型组件减少对分支的需求，或将分支在正则表达式上的位置推后。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cat|bat =&gt; [cb]at</div><div class="line">red|read =&gt; rea?d</div><div class="line">red|raw =&gt; r(?:ed|aw)</div><div class="line">(.|\r|\n) =&gt; [\s\S]</div></pre></td></tr></table></figure>
</li>
<li><p>使用非捕获组</p>
<p>捕获组消耗时间和内存来记录反向引用，并使它保持最新。如果不需要反向引用，最好用<code>(?:...)</code>代替<code>(...)</code></p>
</li>
<li><p>只捕获感兴趣的文本以减少后处理</p>
</li>
<li><p>暴露必需的字元</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/(^ab|^cd)/ =&gt; /^(ab|cd)/</div></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>使用合适的两次</p>
</li>
<li><p>把正则表达式赋值给变量并重用它们</p>
</li>
<li><p>将复杂的正则表达式拆分为简单的片段（化繁为简）</p>
</li>
</ol>
<h4 id="总结：-2"><a href="#总结：-2" class="headerlink" title="总结："></a>总结：</h4><ol>
<li>当连接数量巨大或尺寸巨大的字符串时，数组项连接时唯一在IE7及更早版本中性能合理的方法</li>
<li>如果不需考虑IE7及更早版本的性能，数组项连接时最慢的字符串连接方法之一。推荐使用简单的+和+=操作符替代，避免不必要的中间字符串。</li>
<li>回溯既是正则表达式匹配功能的基本组成部分，也是正则表达式的低效之源。</li>
<li>回溯失控发生在正则表达式本应快速匹配的地方，但因为某些特殊的字符串匹配动作导致运行缓慢甚至浏览器崩溃。避免这个问题的办法是：使用相邻的字元互斥，避免嵌套量词对统一字符串的相同部分多次匹配，通过重复利用向前查看的原子组去除不必要的回溯。</li>
<li>提高正则表达式效率的各种技术手段会有助于正则表达式更快地匹配，并在非匹配位置上花更少的时间。</li>
<li>正则表达式并不总是完成工作的最佳工具，尤其是当你只搜索字面字符串的时候。</li>
<li>尽管有许多方法可以去除字符串的首位空白，但使用两个简单的正则表达式（一个用来去除头部空白，另一个用来去除尾部空白）来处理大量字符串内容能提供一个简洁而跨浏览器的方法。从字符串末尾开始循环向前搜索第一个非空白字符，或者将此技术同正则表达式结合起来，会提供一个更好的替代方案，它很少受到字符串长度影响。</li>
</ol>
<h3 id="快速响应的用户界面"><a href="#快速响应的用户界面" class="headerlink" title="快速响应的用户界面"></a>快速响应的用户界面</h3><p>大多数浏览器让一个单线程共用于执行JS和更新用户界面。每个时刻只能执行其中一种操作，这意味着当JS代码正在执行时用户界面无法响应输入，反之亦然。当JS代码执行时，用户界面处于“锁定”状态。管理好JS的运行时间对Web应用的性能非常重要。</p>
<h4 id="浏览器UI线程"><a href="#浏览器UI线程" class="headerlink" title="浏览器UI线程"></a>浏览器UI线程</h4><p>共用于执行JS和更新用户界面的进程通常被称为“浏览器UI线程”。它的工作基于一个简单的队列系统，任务会被保存到队列中直到进程空闲。一旦空闲，队列中的下一个任务就被重新提取出来并运行。这些任务要么是运行JS代码，要哦恩是执行UI更新，包括重绘和重排。<strong>浏览器会限制JS任务的运行时间：</strong>调用栈大小限制和长时间运行脚本限制。</p>
<h4 id="使用定时器让出时间片段"><a href="#使用定时器让出时间片段" class="headerlink" title="使用定时器让出时间片段"></a>使用定时器让出时间片段</h4><p>让出UI线程的控制权，使得UI可以更新。让出控制权意味着停止执行JS，使得UI线程有机会更新，然后继续执行JS。创建一个定时器会造成UI线程暂停，如同它从一个任务切换到下一个任务。因此，定时器代码会重置所有相关的浏览器限制，包括长时间运行脚本定时器。此外，调用栈也在定时器代码中重置为0.这一特性使得<strong>定时器成为长时间运行JS代码理想的跨浏览器解决方案</strong>。</p>
<h5 id="用定时器处理数组"><a href="#用定时器处理数组" class="headerlink" title="用定时器处理数组"></a>用定时器处理数组</h5><p>是否可以用定时器取代循环的两个决定性因素：</p>
<ul>
<li>处理过程是否必须同步</li>
<li>数据是否必须按顺序处理</li>
</ul>
<p>如为否，则代码适用于定时器分解任务。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> todo = items.concat(); <span class="comment">//克隆原数组</span></div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">// 取得数组的下个元素并进行处理</span></div><div class="line">  process(todo.shift());</div><div class="line">  </div><div class="line">  <span class="comment">// 如果还有需要处理的元素，创建另一个定时器</span></div><div class="line">  <span class="keyword">if</span>(todo.length&gt;<span class="number">0</span>)&#123;</div><div class="line">    setTimeout(<span class="built_in">arguments</span>.callee,<span class="number">25</span>);</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    callback(items);</div><div class="line">  &#125;</div><div class="line">&#125;,<span class="number">25</span>);</div></pre></td></tr></table></figure>
<p>可以对这种模式进行封装</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">processArray</span>(<span class="params">items, process, callback</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> todo = items.concat();</div><div class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    process(todo.shift());</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(todo.length&gt;<span class="number">0</span>)&#123;</div><div class="line">      setTimeout(<span class="built_in">arguments</span>.callee,<span class="number">25</span>);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">      callback(items);</div><div class="line">    &#125;</div><div class="line">  &#125;,<span class="number">25</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">var</span> items = [<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">15</span>,<span class="number">18</span>,...];</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">outputValue</span>(<span class="params">value</span>)</span>&#123;</div><div class="line">  <span class="built_in">console</span>.log(value);</div><div class="line">&#125;</div><div class="line">processArray(items,outputValue,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">console</span>.log(<span class="string">'Done'</span>);&#125;)</div></pre></td></tr></table></figure>
<h5 id="分割任务"><a href="#分割任务" class="headerlink" title="分割任务"></a>分割任务</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">saveDocument</span>(<span class="params">id</span>)</span>&#123;</div><div class="line">  openDocument(id);</div><div class="line">  writeText(id);</div><div class="line">  closeDocument(id)</div><div class="line"></div><div class="line">  updateUI(id);</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>可以用定时器进行分割</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">saveDocument</span>(<span class="params">id</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> tasks = [openDocument, writeText, CloseDocument];</div><div class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> task = tasks.shift();</div><div class="line">    task(id);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(tasks.length&gt;<span class="number">0</span>)&#123;</div><div class="line">      setTimeout(<span class="built_in">arguments</span>.callee,<span class="number">25</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;,<span class="number">25</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对该模式进行封装</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">multistep</span>(<span class="params">steps, args, callback</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> tasks = steps.concat();</div><div class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> task = tasks.shift();</div><div class="line">    task.apply(<span class="literal">null</span>,args || []);</div><div class="line">    <span class="keyword">if</span>(tasks.length&gt;<span class="number">0</span>)&#123;</div><div class="line">      setTimeout(<span class="built_in">arguments</span>.callee,<span class="number">25</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;, <span class="number">25</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="记录代码运行时间"><a href="#记录代码运行时间" class="headerlink" title="记录代码运行时间"></a>记录代码运行时间</h5><p>使每个定时器能处理多个数组条目,避免把任务分解成过于零碎的片断。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">timeProcessArray</span>(<span class="params">items, process, callback</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> todos = items.concat();</div><div class="line">  </div><div class="line">  setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> start =+<span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">    </div><div class="line">    <span class="keyword">do</span>&#123;</div><div class="line">      process(todo.shift());</div><div class="line">    &#125;<span class="keyword">while</span>(todo.length&gt;<span class="number">0</span> &amp;&amp; ((<span class="keyword">new</span> <span class="built_in">Date</span>() - start) &lt; <span class="number">50</span>));</div><div class="line">    </div><div class="line">    <span class="keyword">if</span>(todo.length&gt;<span class="number">0</span>)&#123;</div><div class="line">      setTimeout(<span class="built_in">arguments</span>.callee,<span class="number">25</span>);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">      callback();</div><div class="line">    &#125;</div><div class="line">  &#125;,<span class="number">25</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="定时器与性能"><a href="#定时器与性能" class="headerlink" title="定时器与性能"></a>定时器与性能</h5><p>当多个重复的定时器同时创建往往会出现性能问题。在web应用中限制高频率重复定时器的数量，作为替代方案，创建一个独立的重复定时器，每次执行多个操作</p>
<h4 id="Web-Workers"><a href="#Web-Workers" class="headerlink" title="Web Workers"></a>Web Workers</h4><p>每个新的worker都在自己的线程中运行，这意味着worker运行代码不仅不会影响浏览器UI，也不会影响其他worker中运行的代码。</p>
<h5 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h5><p>因为没有绑定UI线程，所以它们也无法访问浏览器的许多资源。从外部线程中修改DOM会导致用户界面出现错误，但是每个webWorker都有自己的全局运行环境，其功能只是JS特性的一个子集。运行环境组成</p>
<ul>
<li>一个navigator对象，只包括四个属性：appName、appVersion、userAgent和paltform。</li>
<li>一个location对象（与window.location相同，不过所有属性都是只读的）。</li>
<li>一个self对象，指向全局worker对象</li>
<li>一个importScript()方法，用来加载worker所用到的外部JS文件</li>
<li>所有的ECMAScript对象，如: Object、Array……</li>
<li>XMLHttpRequest构造器</li>
<li>setTimeout()和setInterval()方法</li>
<li>一个close方法，它能立刻停止worker运行</li>
</ul>
<p>需要创建一个完全独立的JS文件，其中包含了需要在worker中运行的代码。要创建网页工人线程，必须传入这个JS文件的URL</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> worker = <span class="keyword">new</span> Worker(<span class="string">'code.js'</span>);</div></pre></td></tr></table></figure>
<p>代码执行后，将为这个文件创建一个新的线程和一个新的worker运行环境。该文件会被异步下载，直到文件下载并执行完成后才会启动此Worker。</p>
<h5 id="通信"><a href="#通信" class="headerlink" title="通信"></a>通信</h5><p>消息系统是网页和worker通信的唯一途径。postMessage()可以传递原始值，也可以传递Object和Array的实例，其他类型不允许。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> worker = <span class="keyword">new</span> Worker(<span class="string">'code.js'</span>);</div><div class="line">worker.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">  alert(event.data);</div><div class="line">&#125;;</div><div class="line">worker.postMessage(<span class="string">'Nicholas'</span>);</div><div class="line"></div><div class="line"><span class="comment">// code.js内部代码</span></div><div class="line">self.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">  self.postMessage(<span class="string">'Hello, '</span> + event.data + <span class="string">'!'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="加载外部文件"><a href="#加载外部文件" class="headerlink" title="加载外部文件"></a>加载外部文件</h5><p>通过<code>importScripts()</code>方法加载外部JS文件。该调用过程是阻塞式的，直到所有文件加载并执行完成后，脚本才会继续运行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// code.js内部代码</span></div><div class="line">importScripts(<span class="string">'file1.js'</span>, <span class="string">'file2.js'</span>);</div><div class="line">self.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">  self.postMessage(<span class="string">'hello, '</span> + event.data + <span class="string">'!'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="实际应用"><a href="#实际应用" class="headerlink" title="实际应用"></a>实际应用</h5><p>任何超过100ms的处理过程，都应当考虑worker方案是不是比基于定时器的方案更为合适。WW适用于那些处理纯数据，或者与浏览器UI无关的长时间运行脚本。虽然看上去用处不大，但web应用中通常有一些数据处理功能将受益于worker而不是定时器。如，解析一个很大的JSON字符串、编码/解码大字符串、复杂数学运算（包括图像或视频处理）、大数组排序。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> worker = <span class="keyword">new</span> Worker(<span class="string">'jsonparser.js'</span>);</div><div class="line"><span class="comment">// 传入要解析的大段JSON字符串</span></div><div class="line">worker.postMessage(jsonText);</div><div class="line"></div><div class="line"><span class="comment">// 解析后的数据就位时，调用事件处理器</span></div><div class="line">worker.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> jsonData = event.data;</div><div class="line">  <span class="comment">// 使用解析后的JSON</span></div><div class="line">  evaluateData(jsonData);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* jsonparser.js内部代码 */</span></div><div class="line"><span class="comment">// 当JSON数据存在时，该事件处理器会被调用</span></div><div class="line">self.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123;</div><div class="line">  <span class="comment">// JSON字符串由event.data传入</span></div><div class="line">  <span class="keyword">var</span> jsonText = event.data;</div><div class="line">  </div><div class="line">  <span class="comment">// 解析</span></div><div class="line">  <span class="keyword">var</span> jsonData = <span class="built_in">JSON</span>.parse(jsonText);</div><div class="line">  </div><div class="line">  <span class="comment">// 回传解析后的结果</span></div><div class="line">  self.postMessage(jsonData);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li>任何JS任务都不应当执行超过100ms。过长的运行时间会导致UI更新出现明显的延迟，从而对用户体验产生负面影响。</li>
<li>JS运行期间，浏览器响应用户交互的行为存在差异。无论如何， JS长时间运行将导致用户体验变得混乱和脱节。</li>
<li>定时器可用来安排代码延迟执行，它使得你可以把长时间运行脚本分解成一系列的小任务。</li>
<li>web workers是新版浏览器支持的特性，它允许你在UI线程外部执行JS代码，从而避免锁定UI。</li>
</ol>
<p><strong>web应用越复杂，积极主动地管理UI线程就越重要。没有什么JS代码会重要到可以影响用户体验的程度。</strong></p>
<h3 id="Ajax"><a href="#Ajax" class="headerlink" title="Ajax"></a>Ajax</h3><h4 id="请求"><a href="#请求" class="headerlink" title="请求"></a>请求</h4><h5 id="XMLHttpRequest"><a href="#XMLHttpRequest" class="headerlink" title="XMLHttpRequest"></a>XMLHttpRequest</h5><p><strong>使用XHR时，POST和GET的对比</strong></p>
<p>对于那些不会改变服务器状态，只会获取数据（‘幂等行为’） 的请求，应该使用使用GET。经GET请求的数据会被缓存起来，如果需要多次请求统一数据的话，它会有助于提升性能。只有当请求的URL加上参数的长度接近或超过2048个字符时，才应该用POST获取数据。这是因为IE限制URL长度，过长时会导致请求的URL被截断。</p>
<h5 id="JSONP-动态脚本注入"><a href="#JSONP-动态脚本注入" class="headerlink" title="JSONP(动态脚本注入)"></a>JSONP(动态脚本注入)</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// app.js</span></div><div class="line"><span class="keyword">var</span> scriptEle = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</div><div class="line">scriptEle.src = <span class="string">'http://any-domain.com/javaScript/lib.js'</span>;</div><div class="line"><span class="built_in">document</span>.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>].appendChild(scriptEle);</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonCallback</span>(<span class="params">jsonString</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> data = <span class="built_in">eval</span>(<span class="string">'('</span> + jsonString + <span class="string">')'</span>);</div><div class="line">  <span class="comment">// 处理数据</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// lib.js</span></div><div class="line">jsonCallback(&#123;</div><div class="line">  <span class="string">'userId'</span>: <span class="number">45211322</span>,</div><div class="line">  <span class="string">'name'</span>: <span class="string">'jhon'</span>,</div><div class="line">  <span class="string">'age'</span>: <span class="number">10</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>响应消息必须是可执行的JS代码，无论那种格式的数据，都必须封装在一个回调函数中。但这项技术的速度非常快，响应消息是作为JS代码执行，而不是作为字符串需要进一步处理。</p>
<h5 id="Multipart-XHR"><a href="#Multipart-XHR" class="headerlink" title="Multipart XHR"></a>Multipart XHR</h5><p>允许客户端只用一个HTTP请求就可以从服务器向客户端传送多个资源。它通过在服务器端将多个资源（CSS文件、HTML文件、JS代码或base64编码的图片)打包成一个由双方约定字符串进行分割的长字符串，并发送到客户端。然后客户端用JS处理这个长字符串，并根据它的mime-type类型和传入的其他“头信息”解析出每个资源。</p>
<p>比如，在服务器端用PHP读取三张图片，并转换为base64编码的长字符串。它们之间用简单的unicode编码的字符1连接，然后返回给客户端。</p>
<p>客户端的处理函数，把收到的字符串用<code>str.split(&#39;\u0001&#39;)</code>分成三段，每一段用来创建一个图片元素，然后将图片元素插入到页面中。</p>
<p>这样在一次HTTP请求中向浏览器发送了三张图片。也可以传送更多。不过当MXHR响应消息的体积越来越大，有必要在每个资源收到时就立刻处理，而不是等到整个响应消息接收完成。这可以通过监听readyState为3的状态来实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> req = <span class="keyword">new</span> XMLHTTPRequest();</div><div class="line"><span class="keyword">var</span> getLatestPacketInterval,lastLength = <span class="number">0</span>;</div><div class="line"></div><div class="line">req.open(<span class="string">'GET'</span>, <span class="string">'images.php'</span>, <span class="literal">true</span> );</div><div class="line">req.onreadystatechange = readyStateHandler;</div><div class="line">req.send(<span class="literal">null</span>);</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">readyStateHandler</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(req.readyState == <span class="number">3</span>  &amp;&amp; getLatestPacketInterval === <span class="literal">null</span>)&#123;</div><div class="line">    <span class="comment">// 开始轮询</span></div><div class="line">    getLatestPacketInterval = <span class="built_in">window</span>.setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      getLatestPacket();</div><div class="line">    &#125;,<span class="number">15</span>);</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(req.readyState == <span class="number">4</span>)&#123;</div><div class="line">    <span class="comment">// 停止轮询</span></div><div class="line">    clearInterval(getLatestPacketInterval);</div><div class="line">    <span class="comment">//获取最后一个包</span></div><div class="line">    getLatestPacket();</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getLatestPacket</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> length = req.responseText.length;</div><div class="line">  <span class="keyword">var</span> packet = req.responseText.substring(lastLength, length);</div><div class="line"> </div><div class="line">  processPacket(packet);</div><div class="line">  lastLength = length;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="发送"><a href="#发送" class="headerlink" title="发送"></a>发送</h4><h5 id="XMLHTMLRequest"><a href="#XMLHTMLRequest" class="headerlink" title="XMLHTMLRequest"></a>XMLHTMLRequest</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> url = <span class="string">'/data.php'</span>;</div><div class="line"><span class="keyword">var</span> params = [<span class="string">'id=65623'</span>, <span class="string">'name=jhon'</span>];</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">xhrPost</span>(<span class="params">url,params,callback</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> req = <span class="keyword">new</span> XMLHTTPRequest();</div><div class="line">  req.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      xhr.Post(url,params,callback);</div><div class="line">    &#125;,<span class="number">1000</span>);</div><div class="line">  &#125;;</div><div class="line">  </div><div class="line">  req.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(req.readyState == <span class="number">4</span>)&#123;</div><div class="line">      <span class="keyword">if</span>(callback &amp;&amp; <span class="keyword">typeof</span> callback == <span class="string">'function'</span>)&#123;</div><div class="line">        callback();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">req.open(<span class="string">'POST'</span>,url,<span class="literal">true</span>);</div><div class="line">req.setRequestHeader(<span class="string">'Content-Type'</span>,<span class="string">'application/x-www-form-urlencoded'</span>);</div><div class="line">req.setRequestHeader(<span class="string">'Conten-Length'</span>,params.length);</div><div class="line">req.send(params.join(<span class="string">'&amp;'</span>));</div></pre></td></tr></table></figure>
<h5 id="Beacons-图片信标"><a href="#Beacons-图片信标" class="headerlink" title="Beacons(图片信标)"></a>Beacons(图片信标)</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> url = <span class="string">'/data.php'</span>;</div><div class="line"><span class="keyword">var</span> params = [<span class="string">'id=65623'</span>, <span class="string">'name=jhon'</span>];</div><div class="line"></div><div class="line"><span class="keyword">var</span> beacon = <span class="keyword">new</span> Image();</div><div class="line">beacon.src = url + <span class="string">'?'</span> + params.join(<span class="string">'&amp;'</span>);</div><div class="line"></div><div class="line">beacon.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>.width == <span class="number">1</span>)&#123;</div><div class="line">    <span class="comment">// 成功</span></div><div class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.width == <span class="number">2</span>)&#123;</div><div class="line">    <span class="comment">// 失败，请重试并创建另一个信标</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">beacon.onerror = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">// 失败，请重试并创建另一个信标</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="缓存数据"><a href="#缓存数据" class="headerlink" title="缓存数据"></a>缓存数据</h4><p>最快的Ajax请求就是没有请求，所以避免不必要的请求：</p>
<ul>
<li><p>在服务端，设置HTTP头部信息以确保你的响应会被浏览器缓存</p>
<p>如果希望Ajax响应能够被浏览器缓存，必须用GET方式发送请求。同时必须<strong>在响应中发送正确的HTTP头部信息</strong>。Expires头部信息高速浏览器应该缓存响应多久。其值为一个日期，过期之后，对该URL的任何请求都不再从缓存中获取，而是会重新访问服务器。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Expires: Mon, 28 Jul 2017 23:30:00 GMT</div></pre></td></tr></table></figure>
<p>​</p>
</li>
<li><p>在客户端，把获取到的信息存储到本地，从而避免再次请求</p>
<p>把响应文本保存到一个对象中，以URL为键值索引。在XHR请求时先检查URL是否获取过，如果获取新的URL会存储响应文本到对象中。</p>
</li>
</ul>
<p>总的来说，设置一个Expires头部信息是更好的方案。它实现起来比较容易，而且其缓存内容能够跨页面和跨会话(session)。而手工管理的缓存在你希望编程废止缓存内容并获取更新数据的时候会很有用。本地缓存也可以很好地工作在移动设备上，因为此类设备上大多数浏览器的缓存都很小或者没有缓存，手工管理的缓存成为避免不必要请求的最佳选择。</p>
<h4 id="总结：-3"><a href="#总结：-3" class="headerlink" title="总结："></a>总结：</h4><p>高性能的Ajax包括：</p>
<ol>
<li>了解项目的具体需求</li>
<li>选择正确的数据格式<ul>
<li>作为数据格式，纯文本和HTML只适用于特定场合，但他们可以节省客户端的CPU周期。</li>
<li>XML被广泛应用而且支持良好，但是它十分笨重且解析缓慢。</li>
<li>JSON是轻量级的，解析速度快，通用性与XML相当。</li>
<li>字符分隔的自定义格式十分轻量，在解析大量数据集时非常快，但需要编写额外的服务端构造程序，并在客户端解析。</li>
</ul>
</li>
<li>和与之匹配的传输技术。<ul>
<li>同域时，XHR提供了最完善的控制和灵活性，尽管它会把接收到的所有数据当成一个字符串，且这有可能降低解析速度。</li>
<li>动态脚本注入允许跨域请求和本地执行JS和JSON，但是它的接口不那么安全（涉及敏感数据时不应该使用它），而且还不能读取头信息或响应代码。</li>
<li>Multipart XHR 可以用来减少请求数，并处理一个响应中的各种文件类型，但是它不能缓存接收到的响应。</li>
<li>当发送数据时，图片信标是一种简单而有效的方法。</li>
<li>XHR还可以用POST方法发送大量数据</li>
</ul>
</li>
<li>另外一些准则<ul>
<li>减少请求数，可通过合并JS和CSS文件，或使用MXHR</li>
<li>缩短页面的加载时间，页面主要内容加载完成后，用Ajax获取那些次要文件</li>
<li>确保你的代码错误不会输出给用户，并在服务端处理错误</li>
<li>知道如何使用成熟的Ajax类库，以及何时编写自己的底层Ajax代码</li>
</ul>
</li>
</ol>
<h3 id="编程实践"><a href="#编程实践" class="headerlink" title="编程实践"></a>编程实践</h3><ol>
<li><p><strong>避免双重求值</strong></p>
<p>通过避免使用eval()和Funciton()构造器来避免双重求值带来的性能消耗。同样的，给setTimeout()和setInterval()传递函数而不是字符串作为参数</p>
</li>
<li><p><strong>使用Object/Array直接量</strong></p>
<p>直接量的创建和初始化都比非直接量形式要快</p>
</li>
<li><p><strong>不要重复工作</strong></p>
<p>当需要检测浏览器时，可使用延迟加载或条件预加载</p>
<ol>
<li><p>延迟加载: 适用于当一个函数在页面中不会立刻调用的场合。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">addHandler</span>(<span class="params">target,eventType,handler</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(target.addEventListener)&#123;</div><div class="line">    addHandler = <span class="function"><span class="keyword">function</span>(<span class="params">target,eventType,handler</span>)</span>&#123;</div><div class="line">      target.addEventListener(eventType,handler,<span class="literal">false</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    addHandler = <span class="function"><span class="keyword">function</span>(<span class="params">target,eventType,handler</span>)</span>&#123;</div><div class="line">      target.attachEvent(<span class="string">'on'</span>+eventType,handler);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  addHandler(target,eventType,handler);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">removeHandler</span>(<span class="params">target,eventType,handler</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(target.removeEventListener)&#123;</div><div class="line">    removeHandler = <span class="function"><span class="keyword">function</span>(<span class="params">target,eventType,handler</span>)</span>&#123;</div><div class="line">      target.removeEventListener(eventType,handler,<span class="literal">false</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    removeHandler = <span class="function"><span class="keyword">function</span>(<span class="params">target,eventType,handler</span>)</span>&#123;</div><div class="line">      target.detachEvent(<span class="string">'on'</span></div><div class="line">+ eventType,handler);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  removeHandler(target,eventType,handler);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>条件预加载：适用于一个函数马上就要被用到，并且在整个页面的生命周期中频繁出现的场合。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> addHandler = <span class="built_in">document</span>.body.addEventListener?</div><div class="line">    			<span class="function"><span class="keyword">function</span>(<span class="params">target,eventType,handler</span>)</span>&#123;</div><div class="line">                  target.addEventListener(eventType,handler,<span class="literal">false</span>);</div><div class="line">    			&#125;:</div><div class="line">				<span class="function"><span class="keyword">function</span>(<span class="params">target,eventType,handler</span>)</span>&#123;</div><div class="line">                  target.attachEvent(<span class="string">'on'</span>+eventType,handler);</div><div class="line">				&#125;</div><div class="line"><span class="keyword">var</span> removeHandler = <span class="built_in">document</span>.body.removeEventListener?</div><div class="line">    			<span class="function"><span class="keyword">function</span>(<span class="params">target,eventType,handler</span>)</span>&#123;</div><div class="line">                  target.removeEventListener(eventType,handler,<span class="literal">false</span>);</div><div class="line">    			&#125;:</div><div class="line">				<span class="function"><span class="keyword">function</span>(<span class="params">target,eventType,handler</span>)</span>&#123;</div><div class="line">                  target.detachEvent(<span class="string">'on'</span>+eventType,handler);</div><div class="line">				&#125;</div></pre></td></tr></table></figure>
<p>​</p>
</li>
</ol>
</li>
<li><p><strong>使用速度快的部分</strong></p>
<ol>
<li><p>位操作</p>
<p>在进行数学计算时，考虑使用直接操作数字的二进制形式的位运算</p>
</li>
<li><p>原生方法</p>
<p>原生方法总会比你写的任何代码都要快，尽量使用原生方法。</p>
</li>
</ol>
</li>
</ol>
<h3 id="构建并部署高性能JS应用"><a href="#构建并部署高性能JS应用" class="headerlink" title="构建并部署高性能JS应用"></a>构建并部署高性能JS应用</h3><h4 id="webpack"><a href="#webpack" class="headerlink" title="webpack"></a>webpack</h4><p>可在构建项目时完成以下工作，而不是等到运行时处理。</p>
<ul>
<li>合并多个JS文件</li>
<li>预处理JS文件（loader？）</li>
<li>JS压缩（plugins？）</li>
</ul>
<h4 id="HTTP压缩"><a href="#HTTP压缩" class="headerlink" title="HTTP压缩"></a>HTTP压缩</h4><p>当浏览器发送请求时，会有一个<code>Accept-Encoding</code>HTTP头部，告诉服务器它支持哪种编码转换类型。这个信息主要用来压缩文档以获取更快的下载，从而改善用户体验。其值包括：<code>gzip</code>、<code>compress</code>、<code>deflate</code>、<code>identity</code>。</p>
<p>web服务器在请求中看到这些信息头，会选择最合适的编码方法，并通过<code>Content-Encoding</code>HTTP头部通知浏览器它的决定。</p>
<p>gzip是最流行的编码方式，主要适用于文本，包括JS文件。</p>
<h4 id="缓存JS文件"><a href="#缓存JS文件" class="headerlink" title="缓存JS文件"></a>缓存JS文件</h4><ul>
<li><p>设置Expires响应头部</p>
</li>
<li><p>向<code>&lt;html&gt;</code>标签添加一个manifest属性声明离线应用缓存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html manifest = &quot;demo.manifest&quot;&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="处理缓存问题"><a href="#处理缓存问题" class="headerlink" title="处理缓存问题"></a>处理缓存问题</h4><p>缓存的缺点在于，当应用升级时，你需要确保用户下载到最新的静态内容。这个问题可以通过把改动或的静态资源重命名来解决。</p>
<ul>
<li>给文件添加一个版本或开发编号</li>
<li>附加一个校验和</li>
<li>使用时间戳</li>
</ul>
<h4 id="使用内容分发网络（CDN）"><a href="#使用内容分发网络（CDN）" class="headerlink" title="使用内容分发网络（CDN）"></a>使用内容分发网络（CDN）</h4><p>CDN是在互联网上按地理位置分布计算机网络，它负责传递内容给终端用户。用它的主要原因是增强web应用的可靠性、可扩展性，更重要的是提升性能。事实上，通过向地理位置最近的用户传输内容，CDN能极大减少网络延时。</p>
<h4 id="部署JS资源"><a href="#部署JS资源" class="headerlink" title="部署JS资源"></a>部署JS资源</h4><p>部署JS资源过程通常需要拷贝大量文件到一台或多台远程主机。又是还需要在远程主机上执行一系列的shell命令，尤其是使用CDN时，需要通过传输网络分发新添加的文件。</p>
<h4 id="以上所有这些都应该自动化处理"><a href="#以上所有这些都应该自动化处理" class="headerlink" title="以上所有这些都应该自动化处理"></a><strong>以上所有这些都应该自动化处理</strong></h4><h3 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h3><h4 id="JS性能分析"><a href="#JS性能分析" class="headerlink" title="JS性能分析"></a>JS性能分析</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Timer = &#123;</div><div class="line">  <span class="attr">_data</span>: &#123;&#125;,</div><div class="line">  <span class="attr">start</span>: <span class="function"><span class="keyword">function</span>(<span class="params">key</span>)</span>&#123;</div><div class="line">    Timer._data[key] = <span class="keyword">new</span> <span class="built_in">Date</span>();</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">stop</span>: <span class="function"><span class="keyword">function</span>(<span class="params">key</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> time = Timer._data[key];</div><div class="line">    <span class="keyword">if</span>(time)&#123;</div><div class="line">      Timer._data[key] = <span class="keyword">new</span> <span class="built_in">Date</span>() - time;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">getTime</span>: <span class="function"><span class="keyword">function</span>(<span class="params">key</span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> Time._data[key];</div><div class="line">  &#125;,</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Timer.start(<span class="string">'createElement'</span>);</div><div class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;count;i++)&#123;</div><div class="line">  element = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</div><div class="line">&#125;</div><div class="line">Timer.stop(<span class="string">'createElement'</span>);</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'created'</span> + count + <span class="string">' in '</span> + Timer.getTime(<span class="string">'createElement'</span>));</div></pre></td></tr></table></figure>
<h4 id="YUI-Profiler"><a href="#YUI-Profiler" class="headerlink" title="YUI Profiler"></a>YUI Profiler</h4><h4 id="Firebug"><a href="#Firebug" class="headerlink" title="Firebug"></a>Firebug</h4><h5 id="Profile"><a href="#Profile" class="headerlink" title="Profile"></a>Profile</h5><p>可测试函数被调用次数，函数自身消耗 时间，函数以及被它调用的函数所消耗的总时间</p>
<h5 id="Console-API"><a href="#Console-API" class="headerlink" title="Console API"></a>Console API</h5><h5 id="Network-网络面板"><a href="#Network-网络面板" class="headerlink" title="Network 网络面板"></a>Network 网络面板</h5><h5 id="Page-Speed"><a href="#Page-Speed" class="headerlink" title="Page Speed"></a>Page Speed</h5><h4 id="Filder"><a href="#Filder" class="headerlink" title="Filder"></a>Filder</h4><p>是一个HTTP调试代理工具，能检测到网络中所有资源，以定位加载瓶颈。是一个Windows下的通用网络分析工具，能提供任意浏览器或网络请求的详细报告。</p>
<h4 id="dynaTrace-Ajax-Edition"><a href="#dynaTrace-Ajax-Edition" class="headerlink" title="dynaTrace Ajax Edition"></a>dynaTrace Ajax Edition</h4><p>是一个强大的Java/.NET性能诊断工具。提供了一个全面的性能分析，从网络和页面渲染到运行期间脚本和CPU使用率。分析报告将所有信息汇总显示。</p>
<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><p>每个资源后买的色块条将加载过程分解为不同的阶段（DNS查找、等待响应等）。</p>
<ul>
<li>第一条垂直线（蓝色）表示<strong>页面DOMContentLoaded事件</strong>触发的时刻。这个事件标志着页面的DOM树已经解析完成并准备就绪。</li>
<li>第二条垂直线（红色）表示window的load时间触发时刻，它意味着DOM准备就绪后所有外部资源也已加载完成。</li>
</ul>
<p>这两条线展示了解析和执行所消耗的时间与页面渲染时间的对比。</p>
<p>每个资源</p>
<p>当网页或web应用变慢，分析从网络下载的资源以及分析脚本的运行性能能让你专注于那些最需要优化的地方。</p>
<ul>
<li>使用<strong>网络分析工具</strong>找出加载脚本和页面中其他资源的瓶颈，这会帮助你决定哪些脚本需要延迟加载，或者需要进一步分析。</li>
<li>尽管传统的经验告诉我们要尽量减少HTTP请求，但要<strong>把脚本尽可能延迟加载</strong>可以加快页面渲染速度，给用户带来更好的体验。</li>
<li>使用<strong>性能分析工具</strong>找出脚本运行过程中速度最慢的地方，检查每个函数所消耗的时间，以及函数被调用的次数，通过调用栈自身提供的一些线索来找出需要集中精力优化的地方。</li>
<li>尽管耗费的时间和调试的次数通常是数据中最有价值的部分，但仔细观察函数调用过程，也许会发现其他优化目标。</li>
</ul>
<p>工具会帮助你深入了解你的代码在那些通常你比较陌生的编程环境下是如何运行的。在开始优化工作之前先使用它们，以确保开发时间用在刀刃上。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/高性能JavaScript/" rel="tag">#高性能JavaScript</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/09/13/这几天的收获/" rel="next" title="深夜日记-关于收获">
                <i class="fa fa-chevron-left"></i> 深夜日记-关于收获
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/09/22/沉默的大多数/" rel="prev" title="沉默的大多数">
                沉默的大多数 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/09/13/高性能JS-杂记/"
           data-title="《高性能JS》笔记" data-url="http://chulinyin.com/2016/09/13/高性能JS-杂记/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="chulinyin" />
          <p class="site-author-name" itemprop="name">chulinyin</p>
          <p class="site-description motion-element" itemprop="description">褚林银的秘密基地</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">90</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">76</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#高性能JS"><span class="nav-number">1.</span> <span class="nav-text">高性能JS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#加载和执行"><span class="nav-number">1.1.</span> <span class="nav-text">加载和执行</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#无阻塞下载JS"><span class="nav-number">1.1.1.</span> <span class="nav-text">无阻塞下载JS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据访问"><span class="nav-number">1.2.</span> <span class="nav-text">数据访问</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#作用域"><span class="nav-number">1.2.1.</span> <span class="nav-text">作用域</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#闭包"><span class="nav-number">1.2.2.</span> <span class="nav-text">闭包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#原型"><span class="nav-number">1.2.3.</span> <span class="nav-text">原型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DOM编程"><span class="nav-number">1.3.</span> <span class="nav-text">DOM编程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#DOM访问与修改"><span class="nav-number">1.3.1.</span> <span class="nav-text">DOM访问与修改</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重绘与重排"><span class="nav-number">1.3.2.</span> <span class="nav-text">重绘与重排</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#最小化重绘与重排"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">最小化重绘与重排</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#缓存布局信息"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">缓存布局信息</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#让元素脱离动画刘"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">让元素脱离动画刘</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事件委托"><span class="nav-number">1.3.3.</span> <span class="nav-text">事件委托</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结："><span class="nav-number">1.3.4.</span> <span class="nav-text">总结：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#算法和流程控制"><span class="nav-number">1.4.</span> <span class="nav-text">算法和流程控制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#循环性能"><span class="nav-number">1.4.1.</span> <span class="nav-text">循环性能</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#减少迭代的工作量"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">减少迭代的工作量</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#减少迭代次数"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">减少迭代次数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#基于函数的迭代"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">基于函数的迭代</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#条件语句性能"><span class="nav-number">1.4.2.</span> <span class="nav-text">条件语句性能</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#优化if-else"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">优化if-else</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#查找表"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">查找表</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#递归性能"><span class="nav-number">1.4.3.</span> <span class="nav-text">递归性能</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#递归模式"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">递归模式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#迭代"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">迭代</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Memoization"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">Memoization</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结：-1"><span class="nav-number">1.4.4.</span> <span class="nav-text">总结：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字符串和正则表达式"><span class="nav-number">1.5.</span> <span class="nav-text">字符串和正则表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#字符串连接"><span class="nav-number">1.5.1.</span> <span class="nav-text">字符串连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#正则表达式优化："><span class="nav-number">1.5.2.</span> <span class="nav-text">正则表达式优化：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#工作原理"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">工作原理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#理解回溯"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">理解回溯</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#回溯失控"><span class="nav-number">1.5.2.3.</span> <span class="nav-text">回溯失控</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#解决方案：具体化、使用向前查看和反向引用模拟原子组"><span class="nav-number">1.5.2.4.</span> <span class="nav-text">解决方案：具体化、使用向前查看和反向引用模拟原子组</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#更多提高正则表达式效率的方法"><span class="nav-number">1.5.3.</span> <span class="nav-text">更多提高正则表达式效率的方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结：-2"><span class="nav-number">1.5.4.</span> <span class="nav-text">总结：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#快速响应的用户界面"><span class="nav-number">1.6.</span> <span class="nav-text">快速响应的用户界面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#浏览器UI线程"><span class="nav-number">1.6.1.</span> <span class="nav-text">浏览器UI线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用定时器让出时间片段"><span class="nav-number">1.6.2.</span> <span class="nav-text">使用定时器让出时间片段</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#用定时器处理数组"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">用定时器处理数组</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#分割任务"><span class="nav-number">1.6.2.2.</span> <span class="nav-text">分割任务</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#记录代码运行时间"><span class="nav-number">1.6.2.3.</span> <span class="nav-text">记录代码运行时间</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#定时器与性能"><span class="nav-number">1.6.2.4.</span> <span class="nav-text">定时器与性能</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Web-Workers"><span class="nav-number">1.6.3.</span> <span class="nav-text">Web Workers</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#运行环境"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">运行环境</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通信"><span class="nav-number">1.6.3.2.</span> <span class="nav-text">通信</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#加载外部文件"><span class="nav-number">1.6.3.3.</span> <span class="nav-text">加载外部文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#实际应用"><span class="nav-number">1.6.3.4.</span> <span class="nav-text">实际应用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结"><span class="nav-number">1.6.4.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ajax"><span class="nav-number">1.7.</span> <span class="nav-text">Ajax</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#请求"><span class="nav-number">1.7.1.</span> <span class="nav-text">请求</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#XMLHttpRequest"><span class="nav-number">1.7.1.1.</span> <span class="nav-text">XMLHttpRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JSONP-动态脚本注入"><span class="nav-number">1.7.1.2.</span> <span class="nav-text">JSONP(动态脚本注入)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Multipart-XHR"><span class="nav-number">1.7.1.3.</span> <span class="nav-text">Multipart XHR</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发送"><span class="nav-number">1.7.2.</span> <span class="nav-text">发送</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#XMLHTMLRequest"><span class="nav-number">1.7.2.1.</span> <span class="nav-text">XMLHTMLRequest</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Beacons-图片信标"><span class="nav-number">1.7.2.2.</span> <span class="nav-text">Beacons(图片信标)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存数据"><span class="nav-number">1.7.3.</span> <span class="nav-text">缓存数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结：-3"><span class="nav-number">1.7.4.</span> <span class="nav-text">总结：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编程实践"><span class="nav-number">1.8.</span> <span class="nav-text">编程实践</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#构建并部署高性能JS应用"><span class="nav-number">1.9.</span> <span class="nav-text">构建并部署高性能JS应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#webpack"><span class="nav-number">1.9.1.</span> <span class="nav-text">webpack</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HTTP压缩"><span class="nav-number">1.9.2.</span> <span class="nav-text">HTTP压缩</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存JS文件"><span class="nav-number">1.9.3.</span> <span class="nav-text">缓存JS文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#处理缓存问题"><span class="nav-number">1.9.4.</span> <span class="nav-text">处理缓存问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用内容分发网络（CDN）"><span class="nav-number">1.9.5.</span> <span class="nav-text">使用内容分发网络（CDN）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#部署JS资源"><span class="nav-number">1.9.6.</span> <span class="nav-text">部署JS资源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#以上所有这些都应该自动化处理"><span class="nav-number">1.9.7.</span> <span class="nav-text">以上所有这些都应该自动化处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#工具"><span class="nav-number">1.10.</span> <span class="nav-text">工具</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JS性能分析"><span class="nav-number">1.10.1.</span> <span class="nav-text">JS性能分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#YUI-Profiler"><span class="nav-number">1.10.2.</span> <span class="nav-text">YUI Profiler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Firebug"><span class="nav-number">1.10.3.</span> <span class="nav-text">Firebug</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Profile"><span class="nav-number">1.10.3.1.</span> <span class="nav-text">Profile</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Console-API"><span class="nav-number">1.10.3.2.</span> <span class="nav-text">Console API</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Network-网络面板"><span class="nav-number">1.10.3.3.</span> <span class="nav-text">Network 网络面板</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Page-Speed"><span class="nav-number">1.10.3.4.</span> <span class="nav-text">Page Speed</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Filder"><span class="nav-number">1.10.4.</span> <span class="nav-text">Filder</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dynaTrace-Ajax-Edition"><span class="nav-number">1.10.5.</span> <span class="nav-text">dynaTrace Ajax Edition</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结-1"><span class="nav-number">1.10.6.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chulinyin</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"chulinyin"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("dtz5YifF8WHLzMkG3byRjSM8-gzGzoHsz", "dKrJHG1PJWQKqRRc1YrOva9E");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
